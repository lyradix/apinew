{% extends 'base.html.twig' %}

{% block title %}Hello IndexController!{% endblock %}

{% block body %}
<a href="{{ path('app_adminConcerts') }}" class="btn btn-success"> 
    <img class="logoXtra" src="{{ asset('images/preview.png') }}" alt="logo">
</a>
<h1>Ajouter ou modifier un lieu</h1>

<div>
    <label>
        <input type="radio" name="formMode" value="add" checked>
        Ajouter
    </label>
    <label>
        <input type="radio" name="formMode" value="modify">
        Modifier
    </label>
</div>

<div id="addForm" class="form">
    <form id="poiForm" action="{{ path('post_poi') }}" method="post">
        {{ form_widget(formAddPoi) }}
        <button type="submit">Envoyer</button>
    </form>
</div>

<div id="modifyForm" class="form" style="display:none;">
    <form id="modifForm" method="get">
        <label for="poiId">Sélectionnez le lieu à modifier :</label>
        <select name="poiId" id="poiId" required>
            <option value="">-- Choisir un lieu --</option>
            <!-- Options will be filled by JS -->
        </select>
        <button type="submit">Modifier</button>
    </form>
</div>

<div id="updateForm" class="form">
</div>

<script>
document.querySelectorAll('input[name="formMode"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        if (this.value === 'add') {
            document.getElementById('addForm').style.display = '';
            document.getElementById('modifyForm').style.display = 'none';
            document.getElementById('updateForm').style.display = 'none';
        } else if (this.value === 'modify') {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('modifyForm').style.display = '';
            document.getElementById('updateForm').style.display = 'none';
        }
    });
});

// Hide modifyForm and updateForm by default
document.getElementById('modifyForm').style.display = 'none';
document.getElementById('updateForm').style.display = 'none';

// Handle AJAX POST for add form when type is "scène"
document.getElementById('poiForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const typeField = form.querySelector('[name$="[type]"]');
    const type = typeField ? typeField.value : '';

    if (type === 'scène') {
        fetch('{{ path("app_postScene") }}', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Scène ajoutée avec succès !');
                form.reset();
            } else {
                alert('Erreur : ' + (data.error || 'Une erreur est survenue.'));
            }
        })
        .catch(() => alert('Erreur lors de l\'envoi du formulaire.'));
    } else {
        form.submit(); // fallback for other types
    }
});

document.addEventListener('DOMContentLoaded', function() {
    fetch('/poi') // Your JSON endpoint
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('poiId');
            data.features.forEach(feature => {
                const option = document.createElement('option');
                option.value = feature.id;
                option.textContent = feature.properties.popup || 'POI ' + feature.id;
                select.appendChild(option);
            });
        });

    document.getElementById('modifForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const poiId = document.getElementById('poiId').value;
        if (poiId) {
            window.location.href = '/updatePoi/' + poiId;
        }
    });
});
</script>
{% endblock %}